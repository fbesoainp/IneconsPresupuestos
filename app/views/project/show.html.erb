<link rel="stylesheet" href="https://cdn.datatables.net/1.10.2/css/jquery.dataTables.min.css">
<% content_for :javascript_includes do %>
    <%= javascript_include_tag "jquery.dataTables.min.js" %>
  <% end %>
<div class="panel panel-default">  
<div class="panel-heading">
    <h2><%= @project.name %></h2>
    <p><strong>Ubicacion: </strong> <%= @project.location %> </p>
    <p><strong>Fecha: </strong> <%= @project.date %> </p>
</div> 
</div> 
<div class="panel panel-default">  
<div class="panel-heading">
  <div class="panel-heading-container">
  <h4> <strong> Items </strong> </h4>
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#newItemForm">
  Crear Item
  </button>
  </div>
  </div>
<ul class="list-group">
    <% @items.each do |item| %>
        <% @currentItem = item %>
        <li class="list-group-item">
        <div class='item-container'>
            <div style="display: flex;gap:10px;align-items: center;">
                
                <div style="width: 160px">
                    <h4><%=truncate "#{item.index}. #{item.name}", length: 15, separator: /\w+/%></h4>
                </div>
                <% if item.items.length() > 0 || item.expenses.length() > 0%>

                    <button type="button" class="btn btn-primary" data-toggle="collapse" href=<%="##{item.id}"%>>
                    <span class="glyphicon glyphicon-menu-down"></span>
                    </button>

                <% else %>

                    <button type="button" class="btn btn-default" data-toggle="collapse"%>
                    <span class="glyphicon glyphicon-menu-down"></span>
                    </button>

                <% end %>

                <button type="button" class="btn btn-success" onclick="window.open(<%="'#{itemExpenses_path(item.id)}'"%>,
                'exam_dialog','toolbar=no,location=no,menubar=no,scrollbars=yes,resizable=no,,width=860,height=600')">
                <span class="glyphicon glyphicon-plus"></span>
                </button>

                <button type="button" class="btn btn-primary" data-toggle="modal" data-target=<%="#subItemForm#{item.id}"%>>
                <span class="glyphicon glyphicon-th-list"></span>
                </button>

                <button type="button" class="btn btn-warning" data-toggle="modal" data-target=<%="#editForm#{item.id}"%>>
                <span class="glyphicon glyphicon-edit"></span>
                </button>
                <%= button_to itemDelete_path(item.id), :method => :delete, :class => "btn btn-danger btn-sm" do %>
                    <span class="glyphicon glyphicon-trash"></span>
                <% end %>
            </div>
            <h4><%="SubTotal: #{itemExpenses(item)}"%></h4>
        </div>
        <!-- Edit Form -->
        <div class="modal fade" id=<%="editForm#{item.id}"%> tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Editar Item</h4>
            </div>
            <div class="modal-body">
                
            <%= form_with(model: @currentItem, method: :patch, local: true) do |form| %>
                <div class="form-group">
                    <%=form.label :Nombre, :class => "control-label"%>
                    
                        <%=form.text_field :name, :class => "form-control"%>
                </div>
            
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Volver</button>
                    <input type="submit" name="" value="Editar" class="btn btn-primary">
                </div>
            <% end %>

            </div>
            </div>
        </div>
        </div>

        <!-- SubItem Form -->
        <div class="modal fade" id=<%="subItemForm#{item.id}"%> tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">AÃ±adir SubItem</h4>
            </div>
            <div class="modal-body">
                
            <%= form_with(model: @item, method: :post, local: true) do |form| %>
                <div class="form-group">
                    <%=form.label :Nombre, :class => "control-label"%>
                    
                        <%=form.text_field :name, :class => "form-control"%>
                </div>
            
                <%= form.hidden_field :index, :value => indexSubCalculator(@currentItem.id) %>
                <%= form.hidden_field :item_id, :value => @currentItem.id %>
                <%= form.hidden_field :project_id, :value => params[:id] %>
                <%= form.hidden_field :isMain, :value => false %>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Volver</button>
                    <input type="submit" name="" value="Crear" class="btn btn-primary">
                </div>
            <% end %>

            </div>
            </div>
        </div>
        </div>

        <!-- Sub Iem -->
        <div class="collapse" id=<%="#{item.id}"%>>
            <div class="card card-body">
                <%= itemTableGenerator(item,item.index) %>
            </div>
        </div>
        </li>

    <% end %>
    <li class="list-group-item"> 
    <h4><%="Total: #{projectExpenses(@project)}"%></h4>
    </li>
</ul>
</div>

<%= button_to "Volver", projectIndex_path, class: "btn btn-primary", :method => :get %>

<!-- New Item Form -->
<div class="modal fade" id="newItemForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Crear Item</h4>
      </div>
      <div class="modal-body">
        
      <%= form_with(model: @item, method: :post, local: true) do |form| %>
            <div class="form-group">
                <%=form.label :Nombre, :class => "control-label"%>
                
                    <%=form.text_field :name, :class => "form-control"%>
            </div>
        
            <%= form.hidden_field :index, :value => indexMainCalculator(params[:id]) %>
            <%= form.hidden_field :project_id, :value => params[:id] %>
            <%= form.hidden_field :isMain, :value => true %>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Volver</button>
                <input type="submit" name="" value="Crear" class="btn btn-primary">
            </div>
        <% end %>

      </div>
    </div>
  </div>
</div>


